#!/bin/bash

set -euo pipefail

project_root=$(realpath "$(dirname "$0")")


configure_networkmanager() {
    echo "Enabling NetworkManager.service"
    systemctl enable --now NetworkManager.service
    echo ""
}

set_ntp() {
    echo "Setting ntp..."
    timedatectl set-ntp true
    echo ""
}

configure_reflector() {
   echo "Configuring reflector"
   echo "Updating reflector.conf"
   cp "$project_root/assets/reflector.conf" /etc/xdg/reflector/reflector.conf

   echo "Enabling reflector.service and reflector.timer"
   # Enable reflector.service to run reflector on boot, enabling now also runs it immediately
   systemctl enable --now reflector.service
   systemctl enable reflector.timer

   echo ""
}

configure_pacman() {
    echo "Configuring pacman"
    conf="/etc/pacman.conf"

    echo "Setting Color option"
    if grep -Eq '^[#]*Color' "$conf"; then
        sed -i 's/^[#]*Color/Color/' "$conf"
    else
        sed -i '/^\[options\]/a Color' "$conf"
    fi

    echo "Setting CheckSpace option"
    if grep -Eq '^[#]*CheckSpace' "$conf"; then
        sed -i 's/^[#]*CheckSpace/CheckSpace/' "$conf"
    else
        sed -i '/^\[options\]/a CheckSpace' "$conf"
    fi
    
    echo "Setting VerbosePkgLists option"
    if grep -Eq '^[#]*VerbosePkgLists' "$conf"; then
        sed -i 's/^[#]*VerbosePkgLists/VerbosePkgLists/' "$conf"
    else
        sed -i '/^\[options\]/a VerbosePkgLists' "$conf"
    fi
    
    echo "Setting ParallelDownloads option"
    if grep -Eq '^[#]*ParallelDownloads' "$conf"; then
        sed -i 's/^[#]*ParallelDownloads.*/ParallelDownloads = 10/' "$conf"
    else
        sed -i '/^\[options\]/a ParallelDownloads = 10' "$conf"
    fi

    echo "Setting ILoveCandy option"
    if grep -Eq '^[#]*ILoveCandy' "$conf"; then
        sed -i 's/^[#]*ILoveCandy/ILoveCandy/' "$conf"
    else
        sed -i '/^\[options\]/a ILoveCandy' "$conf"
    fi
    echo ""
}

configure_makepkg() {
    echo "Configuring makepkg"

    # Allow makepkg to use all cores
    sed -i "s/^[#]*MAKEFLAGS\s*=.*/MAKEFLAGS=\"-j$(nproc)\"/" /etc/makepkg.conf
    
    echo ""
}

configure_sudoers() {
    echo "Configuring sudoers"
    sudoers_file="/etc/sudoers"

    # Uncomment the %wheel line if commented
    sed -i 's/^[#]\(%wheel ALL=(ALL:ALL) ALL\)/\1/' "$sudoers_file"

    # Add the Defaults insults line at the end if it's not already there
    if ! grep -q '^Defaults insults$' "$sudoers_file"; then
        {
            echo ""
            echo "#  If set, sudo will insult users when they enter an incorrect password."
            echo "Defaults insults"
        } >> "$sudoers_file"
    fi
    echo ""
}

install_additional_core_packages() {
    echo "Installing additional core packages"
    pacman -Syu --noconfirm bash-completion ed efibootmgr fwupd htop ibus libblockdev-lvm \
        lsof pacman-contrib smartmontools tldr udisks2-lvm2 util-linux \
        wget xdg-utils usbutils git neofetch
    echo ""
}


bash_profile() {
    echo "Updating /etc/profile"

    profile="/etc/profile"

    # Insert the snippet after the last line that starts with 'append_path'
    awk '
        /^append_path/ {
            last_append_line = NR
        }
        { lines[NR] = $0 }
        END {
            for (i=1; i<=NR; i++) {
                print lines[i]
                if (i == last_append_line) {
                    print "# check to see if a user'\''s id is >= 1000 and the $HOME/bin directory exists.  If so, append it to $PATH"
                    print "if [ \"$(id -u)\" -ge 1000 ] && [ -d \"$HOME/bin\" ]; then"
                    print "    append_path \"$HOME/bin\""
                    print "fi"
                }
            }
        }
    ' "$profile" > "${profile}.tmp" && mv "${profile}.tmp" "$profile"

    # Append environment variables at the end
    cat <<'EOF' >> "$profile"

# Set global environment variables (can be overwritten in each userâ€™s .bash_profile)
export EDITOR=vim
export VISUAL=vim
export PAGER=less
EOF

    echo ""
}

configure_bashrc() {
    echo "Updating /etc/bash.bashrc"
    cp "$project_root/assets/bash.bashrc" /etc/bash.bashrc
    echo ""
}

# function to selectively add users to groups
manage_group_membership() {
    local group_name="$1"

    # Check if group exists
    if ! getent group "$group_name" > /dev/null; then
        echo "Error: Group '$group_name' does not exist!" >&2
        return 1
    fi

    echo "Listing users and their membership in the group '$group_name':"
    echo "------------------------------------------------------------"

    # List non-root users (UID >= 1000)
    awk -F: '($3 >= 1000 && $1 != "nobody") { print $1 }' /etc/passwd | while read -r user; do
        if id -nG "$user" | grep -qw "$group_name"; then
            echo "$user: Member"
        else
            echo "$user: Not a member"
        fi
    done

    echo "------------------------------------------------------------"
    echo "Enter the usernames (space-separated) of users to add to the group '$group_name':"
    read -rp "Usernames: " user_list

    # Add each specified user to the group
    for user in $user_list; do
        if id "$user" &> /dev/null; then
            usermod -aG "$group_name" "$user"
            if [[ $? -eq 0 ]]; then
                echo "User '$user' successfully added to the group '$group_name'."
            else
                echo "Error: Could not add user '$user' to the group '$group_name'!" >&2
            fi
        else
            echo "Error: User '$user' does not exist!" >&2
        fi
    done
}

configure_skel() {
    echo "Updating skel"
    echo "Adding /bin to user home"
    # update /etc/skel to add a /bin directory to each user's home.
    mkdir /etc/skel/bin

    echo "Updating .bashrc"
    cp "$project_root/assets/.bashrc" /etc/skel/.bashrc


    echo ""
}

install_polkit() {
    echo "Installing polkit..."
    pacman -S --noconfirm polkit polkit-gnome
    echo ""
}

install_timeshift() {
    echo "Installing timeshift..."
    pacman -S --noconfirm timeshift

    # enable cronie service
    systemctl enable cronie.service
    echo ""
}

install_thunderbolt_utils() {
    echo "Installing thunderbolt utilities..."
    pacman -S --noconfirm bolt tbtools

    echo "Enrolling connected thunderbolt devices..."
    # Get the output of boltctl list
    boltctl_output=$(boltctl list)

    # Extract devices that are connected and authorized
    devices=$(echo "$boltctl_output" | grep -E "name:|uuid:")

    if [ -z "$devices" ]; then
        echo "No connected devices found."
    elif
        # Read each device's name and UUID
        while read -r name_line; do
            read -r uuid_line

            # Extract name and UUID
            name=$(echo "$name_line" | awk -F": " '{print $2}')
            uuid=$(echo "$uuid_line" | awk -F": " '{print $2}')

            # Prompt user to enroll the device
            echo "Device found: $name (UUID: $uuid)"
            read -p "Do you want to enroll this device? (yes/no): " response

            if [[ "$response" =~ ^[Yy][Ee][Ss]$ ]]; then
              # Enroll the device
              boltctl enroll "$uuid"
              if [ $? -eq 0 ]; then
                echo "Device $name (UUID: $uuid) enrolled successfully."
              else
                echo "Failed to enroll device $name (UUID: $uuid)."
              fi
            else
              echo "Skipping enrollment for device $name (UUID: $uuid)."
            fi
        done <<< "$(echo "$devices" | grep -E "name:|uuid:")"
    fi
    echo ""
}


install_util-linux() {
    echo "Installing and configuring util-linux..."
    pacman -S --noconfirm util-linux

    systemctl enable fstrim.timer
    echo ""
}

install_pacman-contrib() {
    echo "Installing and configuring pacman-contrib..."
    pacman -S --noconfirm pacman-contrib

    systemctl enable paccache.timer
}    


configure_networkmanager
set_ntp
configure_reflector
configure_pacman
configure_makepkg
configure_sudoers
install_additional_core_packages
bash_profile
configure_bashrc
configure_skel

install_polkit
install_timeshift
install_thunderbolt_utils


install_util-linux
install_pacman-contrib
